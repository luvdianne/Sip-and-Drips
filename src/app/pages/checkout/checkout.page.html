<ion-header>
  <ion-toolbar style="--background: #f9e9de; --color: #000;">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/cart"></ion-back-button>
    </ion-buttons>
    <ion-title>Checkout</ion-title>
  </ion-toolbar>

  <!-- Progress Steps -->
  <ion-toolbar style="--background: #fff;">
    <div class="checkout-steps">
      <div class="step" [class.active]="currentStep >= 1" [class.completed]="currentStep > 1">
        <div class="step-number">1</div>
        <div class="step-label">Delivery</div>
      </div>
      <div class="step-line" [class.completed]="currentStep > 1"></div>
      <div class="step" [class.active]="currentStep >= 2" [class.completed]="currentStep > 2">
        <div class="step-number">2</div>
        <div class="step-label">Payment</div>
      </div>
      <div class="step-line" [class.completed]="currentStep > 2"></div>
      <div class="step" [class.active]="currentStep >= 3">
        <div class="step-number">3</div>
        <div class="step-label">Review</div>
      </div>
    </div>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding custom-gradient-bg">
  <form #checkoutForm="ngForm">
    <!-- Step 1: Delivery Information -->
    <ion-card *ngIf="currentStep === 1" class="step-card">
      <ion-card-header>
        <ion-card-title>Delivery Information</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-item>
          <ion-label position="floating">Full Name *</ion-label>
          <ion-input 
            [(ngModel)]="orderData.fullName" 
            name="fullName" 
            required
            placeholder="Enter your full name">
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="floating">Phone Number *</ion-label>
          <ion-input 
            [(ngModel)]="orderData.phone" 
            name="phone" 
            type="tel"
            required
            placeholder="+63 XXX XXX XXXX">
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="floating">Email</ion-label>
          <ion-input 
            [(ngModel)]="orderData.email" 
            name="email" 
            type="email"
            placeholder="your@email.com">
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="floating">Street Address *</ion-label>
          <ion-input 
            [(ngModel)]="orderData.address" 
            name="address" 
            required
            placeholder="House/Unit No., Street Name">
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="floating">Barangay *</ion-label>
          <ion-input 
            [(ngModel)]="orderData.barangay" 
            name="barangay" 
            required
            placeholder="Enter barangay">
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="floating">City *</ion-label>
          <ion-input 
            [(ngModel)]="orderData.city" 
            name="city" 
            required
            placeholder="Enter city">
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="floating">Postal Code</ion-label>
          <ion-input 
            [(ngModel)]="orderData.postalCode" 
            name="postalCode" 
            type="number"
            placeholder="1100">
          </ion-input>
        </ion-item>

        <ion-item lines="none">
          <ion-label position="floating">Delivery Notes</ion-label>
          <ion-textarea 
            [(ngModel)]="orderData.notes" 
            name="notes"
            rows="3"
            placeholder="Special instructions for delivery">
          </ion-textarea>
        </ion-item>

        <ion-button 
          expand="block" 
          color="warning"
          class="mt-20"
          (click)="nextStep()"
          [disabled]="!isStep1Valid()">
          Continue to Payment
          <ion-icon name="arrow-forward" slot="end"></ion-icon>
        </ion-button>
      </ion-card-content>
    </ion-card>

    <!-- Step 2: Payment Method -->
    <ion-card *ngIf="currentStep === 2" class="step-card">
      <ion-card-header>
        <ion-card-title>Payment Method</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-radio-group [(ngModel)]="orderData.paymentMethod" name="paymentMethod">
          <ion-item>
            <ion-radio slot="start" value="cod"></ion-radio>
            <ion-label>
              <h3>Cash on Delivery</h3>
              <p>Pay when you receive your order</p>
            </ion-label>
            <ion-icon name="cash-outline" slot="end"></ion-icon>
          </ion-item>

          <ion-item>
            <ion-radio slot="start" value="gcash"></ion-radio>
            <ion-label>
              <h3>GCash</h3>
              <p>Pay via GCash mobile wallet</p>
            </ion-label>
            <ion-icon name="phone-portrait-outline" slot="end"></ion-icon>
          </ion-item>

          <ion-item>
            <ion-radio slot="start" value="card"></ion-radio>
            <ion-label>
              <h3>Credit/Debit Card</h3>
              <p>Visa, Mastercard, etc.</p>
            </ion-label>
            <ion-icon name="card-outline" slot="end"></ion-icon>
          </ion-item>

          <ion-item lines="none">
            <ion-radio slot="start" value="bank"></ion-radio>
            <ion-label>
              <h3>Bank Transfer</h3>
              <p>Direct bank deposit</p>
            </ion-label>
            <ion-icon name="business-outline" slot="end"></ion-icon>
          </ion-item>
        </ion-radio-group>

        <!-- Card Details (if card selected) -->
        <div *ngIf="orderData.paymentMethod === 'card'" class="payment-details">
          <ion-item>
            <ion-label position="floating">Card Number</ion-label>
            <ion-input 
              [(ngModel)]="orderData.cardNumber" 
              name="cardNumber"
              type="text"
              placeholder="1234 5678 9012 3456">
            </ion-input>
          </ion-item>

          <div class="card-row">
            <ion-item>
              <ion-label position="floating">Expiry</ion-label>
              <ion-input 
                [(ngModel)]="orderData.cardExpiry" 
                name="cardExpiry"
                placeholder="MM/YY">
              </ion-input>
            </ion-item>

            <ion-item>
              <ion-label position="floating">CVV</ion-label>
              <ion-input 
                [(ngModel)]="orderData.cardCVV" 
                name="cardCVV"
                type="password"
                maxlength="3"
                placeholder="123">
              </ion-input>
            </ion-item>
          </div>
        </div>

        <!-- GCash Details (if GCash selected) -->
        <div *ngIf="orderData.paymentMethod === 'gcash'" class="payment-details">
          <ion-item>
            <ion-label position="floating">GCash Number</ion-label>
            <ion-input 
              [(ngModel)]="orderData.gcashNumber" 
              name="gcashNumber"
              type="tel"
              placeholder="+63 XXX XXX XXXX">
            </ion-input>
          </ion-item>
        </div>

        <div class="button-group">
          <ion-button 
            expand="block" 
            fill="outline"
            color="warning"
            (click)="previousStep()">
            <ion-icon name="arrow-back" slot="start"></ion-icon>
            Back
          </ion-button>

          <ion-button 
            expand="block" 
            color="warning"
            (click)="nextStep()"
            [disabled]="!orderData.paymentMethod">
            Review Order
            <ion-icon name="arrow-forward" slot="end"></ion-icon>
          </ion-button>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Step 3: Review Order -->
    <div *ngIf="currentStep === 3">
      <!-- Delivery Info Summary -->
      <ion-card class="review-card">
        <ion-card-header>
          <ion-card-title>Delivery Information</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="info-row">
            <ion-icon name="person-outline"></ion-icon>
            <div>
              <strong>{{ orderData.fullName }}</strong>
              <p>{{ orderData.phone }}</p>
            </div>
            <ion-button fill="clear" size="small" (click)="editStep(1)">
              <ion-icon name="create-outline"></ion-icon>
            </ion-button>
          </div>
          <div class="info-row">
            <ion-icon name="location-outline"></ion-icon>
            <div>
              <p>{{ orderData.address }}</p>
              <p>{{ orderData.barangay }}, {{ orderData.city }}</p>
            </div>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Payment Method Summary -->
      <ion-card class="review-card">
        <ion-card-header>
          <ion-card-title>Payment Method</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="info-row">
            <ion-icon [name]="getPaymentIcon()"></ion-icon>
            <div>
              <strong>{{ getPaymentMethodName() }}</strong>
            </div>
            <ion-button fill="clear" size="small" (click)="editStep(2)">
              <ion-icon name="create-outline"></ion-icon>
            </ion-button>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Order Items -->
      <ion-card class="review-card">
        <ion-card-header>
          <ion-card-title>Order Items ({{ cartItemCount }})</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="order-item" *ngFor="let item of cart">
            <div class="item-image-small" [ngClass]="getProductColorClass(item.subcategory)">
              <ion-icon [name]="item.icon"></ion-icon>
            </div>
            <div class="item-details">
              <h4>{{ item.name }}</h4>
              <p>₱{{ item.price }} × {{ item.quantity }}</p>
            </div>
            <div class="item-total">
              ₱{{ item.price * item.quantity }}
            </div>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Order Summary -->
      <ion-card class="summary-card">
        <ion-card-header>
          <ion-card-title>Order Summary</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="summary-row">
            <span>Subtotal</span>
            <span>₱{{ subtotal }}</span>
          </div>
          <div class="summary-row">
            <span>Delivery Fee</span>
            <span>₱{{ deliveryFee }}</span>
          </div>
          <div class="summary-row discount" *ngIf="discount > 0">
            <span>Discount</span>
            <span>-₱{{ discount }}</span>
          </div>
          <div class="summary-row total">
            <span>Total</span>
            <span>₱{{ cartTotal }}</span>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Terms and Conditions -->
      <ion-item lines="none" class="terms-item">
        <ion-checkbox slot="start" [(ngModel)]="agreedToTerms" name="terms"></ion-checkbox>
        <ion-label class="ion-text-wrap">
          I agree to the <a href="#">Terms and Conditions</a> and <a href="#">Privacy Policy</a>
        </ion-label>
      </ion-item>

      <!-- Place Order Button -->
      <div class="button-group">
        <ion-button 
          expand="block" 
          fill="outline"
          color="warning"
          (click)="previousStep()">
          <ion-icon name="arrow-back" slot="start"></ion-icon>
          Back
        </ion-button>

        <ion-button 
          expand="block" 
          color="warning"
          size="large"
          (click)="placeOrder()"
          [disabled]="!agreedToTerms || isProcessing">
          <ion-spinner *ngIf="isProcessing" name="crescent"></ion-spinner>
          <span *ngIf="!isProcessing">Place Order</span>
          <ion-icon *ngIf="!isProcessing" name="checkmark-circle" slot="end"></ion-icon>
        </ion-button>
      </div>
    </div>
  </form>
</ion-content>